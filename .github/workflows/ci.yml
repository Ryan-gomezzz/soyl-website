name: CI

on:
  push:
    branches: [main, feat/**]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies (without Prisma postinstall)
        env:
          PRISMA_SKIP_POSTINSTALL_GENERATE: 1
        run: npm ci --ignore-scripts

      - name: Clear Prisma cache
        run: npx prisma generate --clear-cache || true

      - name: Generate Prisma client
        env:
          PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING: 1
          # DATABASE_URL not required for generation, but set a dummy to avoid warnings
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
        run: |
          echo "Generating Prisma client..."
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if npx prisma generate; then
              echo "Prisma client generated successfully"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Prisma generate failed, retrying in $((RETRY_COUNT * 5)) seconds... (attempt $RETRY_COUNT/$MAX_RETRIES)"
                sleep $((RETRY_COUNT * 5))
              else
                echo "Prisma generate failed after $MAX_RETRIES attempts"
                echo "Checking if Prisma client exists..."
                if [ -f "node_modules/.prisma/client/index.d.ts" ]; then
                  echo "Prisma client exists, continuing..."
                  exit 0
                else
                  echo "Error: Prisma client was not generated successfully"
                  npx prisma --version
                  exit 1
                fi
              fi
            fi
          done
          
          # Verify Prisma client was generated
          if [ ! -f "node_modules/.prisma/client/index.d.ts" ]; then
            echo "Error: Prisma client file not found after generation"
            exit 1
          fi
          echo "Prisma client verified successfully"

      - name: Run linter
        run: npm run lint

      - name: Run tests
        env:
          # Set dummy env vars for tests that don't require real values
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
          NEXT_PUBLIC_RECAPTCHA_SITE_KEY: "dummy"
          NEXT_PUBLIC_UPLOAD_PUBLIC_HINT: "dummy"
          NEXT_PUBLIC_ADMIN_HINT: "dummy"
        run: npm test -- --coverage --watchAll=false

      - name: Build project
        env:
          # Set dummy env vars for build (Next.js will use these during build)
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
          NEXT_PUBLIC_RECAPTCHA_SITE_KEY: "dummy"
          NEXT_PUBLIC_UPLOAD_PUBLIC_HINT: "dummy"
          NEXT_PUBLIC_ADMIN_HINT: "dummy"
        run: npm run build

      - name: Check build output
        run: |
          if [ ! -d ".next" ]; then
            echo "Build failed - .next directory not found"
            exit 1
          fi

